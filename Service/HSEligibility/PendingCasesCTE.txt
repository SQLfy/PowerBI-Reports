WITH CTE AS (
--MEDICAL APPLICATIONS 2023-05-18
SELECT DISTINCT
	APPLICATIONS.OFF_NM AS "Office Name",
	APPLICATIONS.CS_ID AS "Case Number",
	APPLICATIONS.APP_ID AS "Application ID",
	INITCAP(INDV.FIRST_NM ||' '|| INDV.LAST_NM) AS "Head of Household",
	'Medical Assistance' AS "Program",
	APPLICATIONS.APP_DT AS "Application Date",
	APPLICATIONS.APP_DT + 45 AS "Due Date",
        
        --th rename caseloads
        CASE
        WHEN APPLICATIONS.CASELOAD LIKE '%Adult %' THEN 'Adult'
        WHEN APPLICATIONS.CASELOAD LIKE '%Adult-B%' THEN 'Adult-B'
        WHEN APPLICATIONS.CASELOAD LIKE '%LTC%' THEN 'LTC'
        when applications.caseload like '%Transfer%' then 'Transfer'
        when applications.caseload = 'Douglas Medicaid' then 'Medicaid'
        WHEN APPLICATIONS.CASELOAD LIKE 'Douglas%' THEN 'Family'
        WHEN APPLICATIONS.CASELOAD LIKE '%STMartin%' THEN 'Co Works'
        ELSE APPLICATIONS.CASELOAD
    END AS "Caseload",
		
        APPLICATIONS.CASELOAD AS "Caseload2",
	CASE
		WHEN MAX(CS_VRF_OUTS.DUE_DT) > APPLICATIONS.APP_DT
		THEN TO_CHAR(MAX(CS_VRF_OUTS.DUE_DT),'MM/DD/YYYY')
		ELSE 'NA'
	END AS "VCL Due Date",
	'NA' AS "Interview Status"
FROM
	(
		SELECT DISTINCT
			AR_SAWS1_FORM.CS_ID,
			AR_SAWS1_FORM.APP_ID,
			AR_SAWS1_FORM.APP_DT,
			CS_PGM.PGM_TYP_CD,
			CS_PGM.EX_REQ_SW,
			RT_OFF.OFF_NM,
			SE_USR.FIRST_NM ||' '|| SE_USR.LAST_NM AS CASELOAD
		FROM
			AR_SAWS1_FORM
			INNER JOIN CS_PGM
				JOIN CS_PGM_K
					ON CS_PGM.CS_ID = CS_PGM_K.CS_ID
					AND CS_PGM.PGM_TYP_CD = CS_PGM_K.PGM_TYP_CD
					AND CS_PGM.EFF_BGN_DT = CS_PGM_K.LTST_EFF_BGN_DT
				ON AR_SAWS1_FORM.APP_ID = CS_PGM.APP_ID
			INNER JOIN SE_CSLD_PRM_USR
				JOIN SE_CSLD_PRM_USR_K
					ON SE_CSLD_PRM_USR.CSLD_ID = SE_CSLD_PRM_USR_K.CSLD_ID
					AND SE_CSLD_PRM_USR.EFF_BGN_DT = SE_CSLD_PRM_USR_K.LTST_EFF_BGN_DT
				ON CS_PGM.CSLD_ID = SE_CSLD_PRM_USR.CSLD_ID
			INNER JOIN SE_USR_UNT_OFF
				ON SE_CSLD_PRM_USR.USR_ID = SE_USR_UNT_OFF.USR_ID
			INNER JOIN SE_USR
				ON SE_USR_UNT_OFF.USR_ID = SE_USR.USR_ID
			INNER JOIN RT_OFF
				ON SE_USR_UNT_OFF.OFF_ID = RT_OFF.OFF_ID
			INNER JOIN RT_CNTY
				ON RT_OFF.CNTY_CD = RT_CNTY.CNTY_CD
		WHERE
			CS_PGM.PGM_TYP_CD = 'MA'
			AND CS_PGM.PGM_STS_CD = 'PE'
			AND RT_CNTY.CNTY_NM = 'DOUGLAS'
			AND AR_SAWS1_FORM.APP_DT + 35 <= SYSDATE 
            --and cs_pgm.cs_id = '1BEGS33' --test
            
	) APPLICATIONS
	INNER JOIN CS
		JOIN CS_K
			ON CS.CS_ID = CS_K.CS_ID
			AND CS.EFF_BGN_DT = CS_K.LTST_EFF_BGN_DT
		ON APPLICATIONS.CS_ID = CS.CS_ID
	INNER JOIN INDV
		JOIN INDV_K
			ON INDV.CWIN = INDV_K.CWIN
			AND INDV.EFF_BGN_DT = INDV_K.LTST_EFF_BGN_DT
		ON CS.HD_HH_CWIN = INDV.CWIN
	LEFT JOIN CS_VRF_OUTS
		JOIN CS_VRF_OUTS_K
			ON CS_VRF_OUTS.CS_ID = CS_VRF_OUTS_K.CS_ID
			AND CS_VRF_OUTS.OUTS_VRF_ID = CS_VRF_OUTS_K.OUTS_VRF_ID
			AND CS_VRF_OUTS.EFF_BGN_DT = CS_VRF_OUTS_K.LTST_EFF_BGN_DT
		ON APPLICATIONS.CS_ID = CS_VRF_OUTS.CS_ID
		AND APPLICATIONS.PGM_TYP_CD = CS_VRF_OUTS.PGM_TYP_CD
	LEFT JOIN CS_MSD_INTRW
		ON APPLICATIONS.CS_ID = CS_MSD_INTRW.CS_ID
		AND APPLICATIONS.PGM_TYP_CD = CS_MSD_INTRW.PGM_TYP_CD
WHERE
	CS.CS_STS_CD IN ('OP','PE')
GROUP BY
	APPLICATIONS.OFF_NM,
	APPLICATIONS.CS_ID,
	APPLICATIONS.APP_ID,
	INDV.FIRST_NM ||' '|| INDV.LAST_NM,
	APPLICATIONS.PGM_TYP_CD,
	APPLICATIONS.EX_REQ_SW,
	APPLICATIONS.APP_DT,
	INDV.DOB,
	APPLICATIONS.CASELOAD,
	CS_MSD_INTRW.MISS_INTRW_SW,
	CS_MSD_INTRW.MISS_INTRW_DT
    )
    
SELECT
   CASE WHEN "Due Date" > sysdate then 0 else 1 end DueDateFlag
   , cte.*
    FROM CTE
